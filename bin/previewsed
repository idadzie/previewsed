#!/usr/bin/env zsh

# Author: Isaac Dadzie

self=$0
usage() {
  command cat << HELP
Usage: $self [REPLACEMENT EXPRESSION]

Fuzzy find any text file and preview
the output of a sed replacement expression.
HELP
}

if [[ $# -eq 0 ]]; then
  usage && return 1
fi

opts="
  $FZF_DEFAULT_OPTS
  --preview-window right:50%
  --preview '(bat --style=numbers,changes --wrap never --color always {} || highlight -O ansi -l {} || cat {}) 2> /dev/null | head -200'
  --bind '?:toggle-preview'
  --bind='alt-w:toggle-preview-wrap'
  --bind='alt-k:preview-up,alt-p:preview-up'
  --bind='alt-j:preview-down,alt-n:preview-down'
  --exit-0
"

selected=$(print -ln **/*.md | FZF_DEFAULT_OPTS="$opts" fzf)

if (( $+commands[bat] )); then
  _cmd=bat
elif (( $+commands[highlight])); then
  _cmd=highlight -O ansi -l
else
  _cmd=cat
fi

sed $@ $selected | ${_cmd}
